#!/bin/bash
# Pre-commit hook for omni-core
# Runs formatting, linting, and tests before allowing commit

set -e

echo "ğŸ” Pre-commit checks..."

# Get the root directory
ROOT_DIR="$(git rev-parse --show-toplevel)"

# Check if any Rust files are staged
RUST_STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)

if [ -n "$RUST_STAGED" ]; then
    echo "ğŸ“¦ Checking Rust code..."
    
    # Format check
    echo "  â†’ cargo fmt"
    cargo fmt --all -- --check
    
    # Clippy
    echo "  â†’ cargo clippy"
    cargo clippy --all-targets --all-features -- -D warnings -A warnings
    
    # Tests
    echo "  â†’ cargo test"
    cargo test --all --quiet
    
    echo "âœ… Rust checks passed"
fi

# Check if any frontend files are staged
FRONTEND_STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/.*\.(ts|tsx|js|jsx)$' || true)

if [ -n "$FRONTEND_STAGED" ]; then
    echo "ğŸŒ Checking Frontend code..."
    
    if [ -d "$ROOT_DIR/frontend/node_modules" ]; then
        cd "$ROOT_DIR/frontend"
        
        # TypeScript check
        echo "  â†’ tsc --noEmit"
        npx tsc --noEmit
        
        echo "âœ… Frontend checks passed"
    else
        echo "âš ï¸  Skipping frontend checks (run 'npm install' in frontend/)"
    fi
fi

echo "ğŸ‰ Pre-commit checks complete!"
